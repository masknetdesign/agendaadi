<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda ADI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script type="module">
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBkrBLKuklZgPm1nz2G997ULiYycZMb9F8",
            authDomain: "avisoseeventos.firebaseapp.com",
            databaseURL: "https://avisoseeventos-default-rtdb.firebaseio.com",
            projectId: "avisoseeventos",
            storageBucket: "avisoseeventos.appspot.com",
            messagingSenderId: "247706769451",
            appId: "1:247706769451:web:ce31cd9d0ca22cd267b26e",
            measurementId: "G-QE1Z4RQ60T"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        // Obter instância do Firestore
        window.db = firebase.firestore();
    </script>
    <style>
        /* Reset e estilos base */
        html, body {
            overflow-x: hidden;
            width: 100%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Estilos para o cabeçalho */
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 2rem 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Estilos para as abas principais */
        .tab-container {
            background: white;
            border-radius: 1rem;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .tab-button {
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        .tab-button:hover {
            transform: translateY(-2px);
        }

        .active-tab {
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Estilos para o seletor de dia */
        .day-selector {
            background: white;
            border-radius: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .day-selector select {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            border: none;
            background: transparent;
            padding: 0.5rem 1rem;
            width: 100%;
            cursor: pointer;
        }

        /* Estilos para as abas de categoria */
        .category-tabs-container {
            background: white;
            border-radius: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .category-tabs-scroll {
            display: flex;
            flex-wrap: nowrap;
            padding-bottom: 0.5rem;
        }

        #category-tabs {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.5rem;
            padding: 0.25rem;
            min-width: min-content;
        }

        .category-tab {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            white-space: nowrap;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            min-width: max-content;
            background: #f8f9fa;
        }

        .category-tab:hover {
            background: rgba(44, 82, 130, 0.1);
        }
        
        .category-tab.active {
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .category-tab i {
            font-size: 1rem;
        }

        @media (max-width: 640px) {
            .category-tabs-container {
                margin: 0 -1rem 1rem -1rem;
                border-radius: 0;
            }

            .category-tabs-scroll {
                padding: 0.25rem;
            }

            .category-tab {
                padding: 0.375rem 0.75rem;
                font-size: 0.813rem;
            }

            .category-tab i {
                font-size: 0.875rem;
            }
        }

        /* Estilos para os cards de evento */
        .event-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .event-card h4 {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: #1a365d;
            margin-bottom: 0.5rem;
        }

        .event-time {
            background: linear-gradient(135deg, #4299e1 0%, #2b6cb0 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
        }

        /* Estilos para a notificação */
        .notification {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #2c5282;
        }

        .notification h3 {
            font-family: 'Playfair Display', serif;
            color: #1a365d;
        }

        /* Estilos para datas */
        .date-section h3 {
            font-family: 'Playfair Display', serif;
            color: #1a365d;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(44, 82, 130, 0.1);
        }

        /* Responsividade */
        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1.5rem 0;
                border-radius: 0 0 1.5rem 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .event-card {
                padding: 1rem;
            }
        }

        /* Estilos para o sino de notificação */
        .notification-bell {
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .notification-bell:hover {
            transform: scale(1.1);
        }

        .notification-bell.ringing {
            animation: ring 0.5s ease-in-out;
        }

        @keyframes ring {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            50% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
            100% { transform: rotate(0deg); }
        }

        /* Estilos para o popup de notificação */
        .notification-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 90%;
            width: 400px;
            display: none;
        }

        .notification-popup.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .notification-overlay.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Estilos para o banner de instalação do PWA */
        #pwa-install-banner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a365d;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
        }

        #pwa-install-banner.show {
            display: flex;
        }

        .install-button {
            background-color: #4299e1;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .install-button:hover {
            background-color: #3182ce;
        }

        #pwa-close-button {
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: opacity 0.2s;
        }

        /* Estilos do banner de instalação */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        .install-banner.show {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .install-banner-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .install-banner-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
        }

        .install-banner-text {
            flex: 1;
        }

        .install-banner-title {
            font-weight: 600;
            color: #1a365d;
            margin-bottom: 0.25rem;
        }

        .install-banner-description {
            font-size: 0.875rem;
            color: #4a5568;
        }

        .install-banner-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-install {
            background: #1a365d;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-install:hover {
            background: #2c5282;
        }

        .btn-later {
            color: #4a5568;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-later:hover {
            background: #f1f5f9;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        @media (max-width: 640px) {
            .install-banner {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .install-banner-content {
                flex-direction: column;
            }

            .install-banner-buttons {
                width: 100%;
                flex-direction: column;
            }

            .btn-install, .btn-later {
                width: 100%;
                text-align: center;
            }
        }
    </style>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a365d">
    <meta name="description" content="Agenda de eventos e ensaios da ADI">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Agenda ADI">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Agenda ADI">
    
    <!-- PWA Links -->
    <link rel="manifest" href="/agendaadi/manifest.json">
    <link rel="apple-touch-icon" href="/agendaadi/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/agendaadi/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/agendaadi/icons/icon-512x512.png">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container">
        <header class="header text-center">
            <h1>Agenda da Igreja</h1>
            <p>Programação semanal de atividades e eventos</p>
            <div class="notification-bell absolute top-4 right-4">
                <button id="notification-bell" class="relative">
                    <i class="fas fa-bell text-white text-2xl"></i>
                    <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </header>
        
        <!-- Abas principais -->
        <div class="flex justify-center mb-6">
            <div class="tab-container inline-flex rounded-lg">
                <button id="events-tab" class="tab-button px-6 py-3 text-sm font-medium rounded-lg active-tab" aria-current="page">
                    <i class="fas fa-calendar-alt mr-2"></i>Eventos
                </button>
                <button id="rehearsals-tab" class="tab-button px-6 py-3 text-sm font-medium rounded-lg">
                    <i class="fas fa-music mr-2"></i>Ensaios
                </button>
            </div>
        </div>
        
        <div id="events-section">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <div class="w-full max-w-xs">
                    <div class="day-selector">
                        <select id="day-filter" class="w-full">
                            <option value="all">Todos os dias</option>
                            <option value="0">Domingo</option>
                            <option value="1">Segunda-feira</option>
                            <option value="2">Terça-feira</option>
                            <option value="3">Quarta-feira</option>
                            <option value="4">Quinta-feira</option>
                            <option value="5">Sexta-feira</option>
                            <option value="6">Sábado</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="category-tabs-container">
                <div class="category-tabs-scroll">
                    <div id="category-tabs" class="flex space-x-2">
                        <!-- Categories will be loaded here dynamically -->
                    </div>
                </div>
        </div>
        
        <div id="events-container" class="relative min-h-64">
            <!-- Event cards will be inserted here by JavaScript -->
        </div>
                </div>
                </div>

    <!-- Popup de notificação -->
    <div id="notification-overlay" class="notification-overlay"></div>
    <div id="notification-popup" class="notification-popup">
        <div class="flex justify-between items-start mb-4">
            <h3 id="popup-title" class="text-xl font-semibold text-gray-800"></h3>
            <button id="close-popup" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        <div class="flex items-center mb-2">
            <i id="popup-icon" class="fas mr-2 text-gray-500"></i>
            <span id="popup-category" class="text-gray-500"></span>
        </div>
        <div class="flex items-center mb-4">
            <i class="fas fa-clock mr-2 text-gray-500"></i>
            <span id="popup-time" class="text-gray-500"></span>
        </div>
        <div class="flex items-center">
            <i class="fas fa-calendar mr-2 text-gray-500"></i>
            <span id="popup-date" class="text-gray-500"></span>
        </div>
    </div>

    <!-- Elemento de áudio pré-carregado -->
    <audio id="bell-sound" preload="auto" controls style="display: none;">
        <source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU" type="audio/wav">
    </audio>

    <!-- Banner de instalação do PWA -->
    <div id="install-banner" class="install-banner">
        <div class="install-banner-content">
            <img src="/agendaadi/icons/icon-192x192.png" alt="Agenda ADI" class="install-banner-icon">
            <div class="install-banner-text">
                <div class="install-banner-title">Instale a Agenda ADI</div>
                <div class="install-banner-description">Acesse a agenda diretamente do seu dispositivo</div>
            </div>
        </div>
        <div class="install-banner-buttons">
            <button id="install-button" class="btn-install">
                <i class="fas fa-download mr-2"></i>
                Instalar
            </button>
            <button id="install-later" class="btn-later">Depois</button>
        </div>
    </div>

    <script>
        // Days of the week
        const days = [
            "Domingo", "Segunda-feira", "Terça-feira", 
            "Quarta-feira", "Quinta-feira", "Sexta-feira", 
            "Sábado"
        ];
        
        // Months names
        const months = [
            "janeiro", "fevereiro", "março", "abril", "maio", "junho",
            "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"
        ];
        
        // Estado da aplicação
        const state = {
            currentTab: 'all',
            currentDay: 'all',
            currentView: 'events',
            categories: new Map(),
            eventsData: {
                all: []
            },
            rehearsalsData: {
                all: []
            },
            notificationCount: 0,
            processedItems: new Set()
        };

        // Elementos DOM
        const elements = {
            notificationBell: document.getElementById('notification-bell'),
            notificationCount: document.getElementById('notification-count'),
            notificationPopup: document.getElementById('notification-popup'),
            notificationOverlay: document.getElementById('notification-overlay'),
            closePopupButton: document.getElementById('close-popup'),
            eventsContainer: document.getElementById('events-container'),
            categoryTabs: document.getElementById('category-tabs')
        };

        // Funções de utilidade
        const utils = {
            formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString('pt-BR');
            },
            formatTime(timeString) {
                return timeString;
            },
            getDayName(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString('pt-BR', { weekday: 'long' });
            }
        };

        // Carrega as categorias
        async function loadCategories() {
            try {
                const categoriesRef = db.collection('categories');
                const snapshot = await categoriesRef.get();
                state.categories.clear();
                snapshot.forEach(doc => {
                    state.categories.set(doc.id, {
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateCategoryTabs();
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Carrega os eventos
        async function loadEvents() {
            try {
                const eventsRef = db.collection('events');
                const snapshot = await eventsRef.get();
                
                // Inicializa arrays para todas as categorias
                state.eventsData = { all: [] };
                state.categories.forEach((category, id) => {
                    state.eventsData[id] = [];
                });

                // Processa cada evento
                snapshot.forEach(doc => {
                    const eventObj = {
                        id: doc.id,
                        ...doc.data(),
                        type: 'event',
                        categoryName: state.categories.get(doc.data().category)?.name || 'Sem categoria',
                        categoryIcon: state.categories.get(doc.data().category)?.icon || 'fa-calendar'
                    };
                    
                    // Adiciona ao array 'all' e à categoria específica
                    state.eventsData.all.push(eventObj);
                    if (eventObj.category) {
                        state.eventsData[eventObj.category].push(eventObj);
                    }
                });

                renderCurrentView();
            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
            }
        }

        // Carrega os ensaios
        async function loadRehearsals() {
            try {
                const rehearsalsRef = db.collection('rehearsals');
                const snapshot = await rehearsalsRef.get();
                
                // Inicializa arrays para todas as categorias
                state.rehearsalsData = { all: [] };
                state.categories.forEach((category, id) => {
                    state.rehearsalsData[id] = [];
                });

                // Processa cada ensaio
                snapshot.forEach(doc => {
                    const rehearsalObj = {
                        id: doc.id,
                        ...doc.data(),
                        type: 'rehearsal',
                        categoryName: state.categories.get(doc.data().category)?.name || 'Sem categoria',
                        categoryIcon: state.categories.get(doc.data().category)?.icon || 'fa-music'
                    };
                    
                    // Adiciona ao array 'all' e à categoria específica
                    state.rehearsalsData.all.push(rehearsalObj);
                    if (rehearsalObj.category) {
                        state.rehearsalsData[rehearsalObj.category].push(rehearsalObj);
                    }
                });

                renderCurrentView();
            } catch (error) {
                console.error('Erro ao carregar ensaios:', error);
            }
        }

        // Atualiza as abas de categoria
        function updateCategoryTabs() {
            const tabsContainer = document.getElementById('category-tabs');
            const allTab = `
                <button class="category-tab ${state.currentTab === 'all' ? 'active' : ''}" 
                        data-category="all">
                    <i class="fas fa-calendar-alt"></i> Todos
                </button>`;
            
            const categoryTabs = Array.from(state.categories.values())
                .map(category => `
                    <button class="category-tab ${state.currentTab === category.id ? 'active' : ''}" 
                            data-category="${category.id}">
                        <i class="fas ${category.icon}"></i> ${category.name}
                    </button>
                `).join('');
            
            tabsContainer.innerHTML = allTab + categoryTabs;

            // Adiciona eventos de clique
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    state.currentTab = tab.dataset.category;
                    updateCategoryTabs();
                    renderCurrentView();
                });
            });
        }

        // Renderiza a visualização atual
        function renderCurrentView() {
            const container = document.getElementById('events-container');
            let items = [];

            // Seleciona os itens baseado na visualização atual (eventos ou ensaios)
            if (state.currentView === 'events') {
                items = state.currentTab === 'all' ? state.eventsData.all : (state.eventsData[state.currentTab] || []);
            } else {
                items = state.currentTab === 'all' ? state.rehearsalsData.all : (state.rehearsalsData[state.currentTab] || []);
            }

            // Filtra por dia se necessário
            if (state.currentDay !== 'all') {
                items = items.filter(item => {
                    const date = new Date(item.date + 'T00:00:00');
                    return date.getDay().toString() === state.currentDay;
                });
            }

            // Ordena por data e hora
            items.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateA - dateB;
            });

            // Agrupa por data
            const groupedByDate = items.reduce((groups, item) => {
                const date = item.date;
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(item);
                return groups;
            }, {});

            // Gera o HTML
            let html = '';
            if (Object.keys(groupedByDate).length === 0) {
                html = '<p class="text-center text-gray-500 my-4">Nenhum item encontrado para esta seleção.</p>';
            } else {
                Object.entries(groupedByDate).forEach(([date, dateItems]) => {
                    html += `
                        <div class="date-group mb-6">
                            <h3 class="text-lg font-semibold mb-3">${utils.formatDate(date)} - ${utils.getDayName(date)}</h3>
                            <div class="grid gap-4">
                                ${dateItems.map(item => `
                                    <div class="bg-white rounded-lg shadow-md p-4 flex items-center">
                                        <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                                            <i class="fas ${item.categoryIcon} text-blue-600 text-xl"></i>
                                        </div>
                                        <div class="flex-grow">
                                            <h4 class="font-semibold">${item.title}</h4>
                                            <p class="text-sm text-gray-600">
                                                <span class="mr-2">${item.categoryName}</span>
                                                <span>${utils.formatTime(item.time)}</span>
                                            </p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        // Configuração dos filtros de dia
        document.getElementById('day-filter').addEventListener('change', (e) => {
            state.currentDay = e.target.value;
            renderCurrentView();
        });

        // Configuração das abas principais
        document.getElementById('events-tab').addEventListener('click', () => {
            state.currentView = 'events';
            document.getElementById('events-tab').classList.add('active-tab');
            document.getElementById('rehearsals-tab').classList.remove('active-tab');
            renderCurrentView();
        });

        document.getElementById('rehearsals-tab').addEventListener('click', () => {
            state.currentView = 'rehearsals';
            document.getElementById('rehearsals-tab').classList.add('active-tab');
            document.getElementById('events-tab').classList.remove('active-tab');
            renderCurrentView();
        });

        // Função para configurar listeners em tempo real
        function setupRealtimeListeners() {
            // Listener para novos eventos
            db.collection('events')
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const eventData = {
                                id: change.doc.id,
                                ...change.doc.data()
                            };

                            // Verificar se o evento foi criado nos últimos 30 segundos
                            const createdAt = eventData.createdAt?.toDate() || new Date();
                            const now = new Date();
                            const timeDiff = (now - createdAt) / 1000; // diferença em segundos

                            if (timeDiff <= 30 && !state.processedItems.has(eventData.id)) {
                                state.processedItems.add(eventData.id);
                                const enrichedEventData = {
                                    ...eventData,
                                    type: 'event',
                                    categoryName: state.categories.get(eventData.category)?.name || 'Sem categoria',
                                    categoryIcon: state.categories.get(eventData.category)?.icon || 'fa-calendar'
                                };
                                
                                showNotification(enrichedEventData);
                                loadEvents();
                            }
                        }
                    });
                }, (error) => {
                    console.error("Erro ao observar eventos:", error);
                });

            // Listener para novos ensaios
            db.collection('rehearsals')
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const rehearsalData = {
                                id: change.doc.id,
                                ...change.doc.data()
                            };

                            // Verificar se o ensaio foi criado nos últimos 30 segundos
                            const createdAt = rehearsalData.createdAt?.toDate() || new Date();
                            const now = new Date();
                            const timeDiff = (now - createdAt) / 1000; // diferença em segundos

                            if (timeDiff <= 30 && !state.processedItems.has(rehearsalData.id)) {
                                state.processedItems.add(rehearsalData.id);
                                const enrichedRehearsalData = {
                                    ...rehearsalData,
                                    type: 'rehearsal',
                                    categoryName: state.categories.get(rehearsalData.category)?.name || 'Sem categoria',
                                    categoryIcon: state.categories.get(rehearsalData.category)?.icon || 'fa-music'
                                };
                                
                                showNotification(enrichedRehearsalData);
                                loadRehearsals();
                            }
                        }
                    });
                }, (error) => {
                    console.error("Erro ao observar ensaios:", error);
                });
        }

        // Função para mostrar notificação
        function showNotification(item) {
            console.log('Mostrando notificação para:', item); // Debug

            // Incrementar contador de notificações
            state.notificationCount++;
            elements.notificationCount.textContent = state.notificationCount;
            elements.notificationCount.classList.remove('hidden');
            
            // Reproduzir som e animação
            playBellSound();
            
            // Atualizar conteúdo do popup
            document.getElementById('popup-title').textContent = item.title;
            document.getElementById('popup-category').textContent = item.categoryName;
            document.getElementById('popup-time').textContent = item.time;
            document.getElementById('popup-date').textContent = utils.formatDate(item.date);
            document.getElementById('popup-icon').className = `fas ${item.categoryIcon} mr-2 text-gray-500`;

            // Mostrar popup
            elements.notificationPopup.classList.add('show');
            elements.notificationOverlay.classList.add('show');

            // Configurar temporizador para fechar o popup após 5 segundos
            setTimeout(() => {
                elements.notificationPopup.classList.remove('show');
                elements.notificationOverlay.classList.remove('show');
            }, 5000);
        }

        // Função para reproduzir o som do sino
        async function playBellSound() {
            try {
                console.log('Reproduzindo som do sino...'); // Debug
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Criar oscilador para o som do sino
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // Nota A4
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
                
                // Animar o sino
                elements.notificationBell.classList.add('ringing');
                setTimeout(() => {
                    elements.notificationBell.classList.remove('ringing');
                }, 500);
                
            } catch (error) {
                console.error('Erro ao reproduzir som do sino:', error);
            }
        }

        // Event listeners
        elements.closePopupButton.addEventListener('click', () => {
            elements.notificationPopup.classList.remove('show');
            elements.notificationOverlay.classList.remove('show');
        });

        elements.notificationOverlay.addEventListener('click', () => {
            elements.notificationPopup.classList.remove('show');
            elements.notificationOverlay.classList.remove('show');
        });

        elements.notificationBell.addEventListener('click', () => {
            // Resetar contador ao clicar no sino
            state.notificationCount = 0;
            elements.notificationCount.textContent = '0';
            elements.notificationCount.classList.add('hidden');
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Iniciando aplicação...'); // Debug
                await loadCategories();
                await Promise.all([loadEvents(), loadRehearsals()]);
                
                // Configurar estado inicial
                state.currentView = 'events';
                document.getElementById('events-tab').classList.add('active-tab');
                document.getElementById('rehearsals-tab').classList.remove('active-tab');

                // Configurar listeners em tempo real
                setupRealtimeListeners();
                console.log('Listeners configurados com sucesso'); // Debug
            } catch (error) {
                console.error('Erro na inicialização:', error);
            }
        });

        // Service Worker Registration (moved here for consistency)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/agendaadi/sw.js', { scope: '/agendaadi/' })
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar o Service Worker:', error);
                    });
            });
        }

        // Variáveis para instalação do PWA
        let deferredPrompt;
        const installBanner = document.getElementById('install-banner');
        const installButton = document.getElementById('install-button');
        const installLater = document.getElementById('install-later');

        // Evento para capturar o prompt de instalação
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('Capturado evento beforeinstallprompt');
            e.preventDefault();
            deferredPrompt = e;
            checkInstallBanner(); // Check if banner should be shown now
        });

        // Evento de clique no botão de instalação
        installButton.addEventListener('click', async () => {
            console.log('Clicou no botão de instalação');
            if (!deferredPrompt) {
                console.log('Nenhum prompt de instalação disponível');
                return;
            }

            try {
                const result = await deferredPrompt.prompt();
                console.log('Resultado do prompt:', result);
                if (result.outcome === 'accepted') {
                    console.log('Usuário aceitou a instalação');
                } else {
                    console.log('Usuário recusou a instalação');
                }
                deferredPrompt = null;
                installBanner.classList.remove('show');
            } catch (error) {
                console.error('Erro ao mostrar prompt de instalação:', error);
            }
        });

        // Evento de clique no botão "Depois"
        installLater.addEventListener('click', () => {
            console.log('Instalação adiada pelo usuário');
            installBanner.classList.remove('show');
            // Salva a preferência do usuário para não mostrar o banner por 7 dias
            const nextPrompt = new Date();
            nextPrompt.setDate(nextPrompt.getDate() + 7);
            localStorage.setItem('nextInstallPrompt', nextPrompt.toISOString());
        });

        // Verifica se o app já está instalado
        window.addEventListener('appinstalled', (e) => {
            console.log('Aplicativo instalado com sucesso');
            installBanner.classList.remove('show');
            deferredPrompt = null;
        });

        // Função para verificar se deve mostrar o banner
        function checkInstallBanner() {
            // Don't show banner if already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('Aplicativo já está instalado (standalone)');
                installBanner.classList.remove('show');
                return;
            }
            if (window.navigator.standalone === true) {
                console.log('Aplicativo já está instalado (iOS)');
                installBanner.classList.remove('show');
                return;
            }

            const nextPrompt = localStorage.getItem('nextInstallPrompt');
            if (nextPrompt) {
                const now = new Date();
                const promptDate = new Date(nextPrompt);
                if (now < promptDate) {
                    console.log('Banner adiado até:', promptDate);
                    installBanner.classList.remove('show');
                    return;
                }
            }

            // Se houver um prompt e não estivermos adiados, mostra o banner
            if (deferredPrompt) {
                console.log('Mostrando banner de instalação');
                installBanner.classList.add('show');
            } else {
                 console.log('Nenhum prompt de instalação disponível no momento para mostrar o banner.');
                 installBanner.classList.remove('show');
            }
        }

        // Verifica o banner ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            // A verificação inicial do banner agora depende do 'beforeinstallprompt'
            // para garantir que temos o deferredPrompt
        });
    </script>
</body>
</html>